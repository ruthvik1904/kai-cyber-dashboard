/**
 * Individual vulnerability card component
 */

import { Link as RouterLink } from 'react-router-dom';
import { Box, Badge, Text, VStack, HStack, Link as ChakraLink, Checkbox, useColorModeValue } from '@chakra-ui/react';
import { memo } from 'react';
import { FlattenedVulnerability } from '../../types/vulnerability';

interface VulnerabilityCardProps {
  vulnerability: FlattenedVulnerability;
  isSelected: boolean;
  onToggleSelect: (cveId: string) => void;
}

const severityColors: Record<string, string> = {
  critical: 'red',
  high: 'orange',
  medium: 'yellow',
  low: 'green',
};

function VulnerabilityCard({ vulnerability, isSelected, onToggleSelect }: VulnerabilityCardProps) {
  const severityColor = severityColors[vulnerability.severity.toLowerCase()] || 'gray';
  const detailPath = `/vulnerabilities/${encodeURIComponent(vulnerability.cve)}`;
  const metaTextColor = useColorModeValue('gray.600', 'gray.300');
  const descriptionColor = useColorModeValue('gray.700', 'gray.300');
  const infoColor = useColorModeValue('gray.500', 'gray.400');
  const selectedBg = useColorModeValue('blue.50', 'rgba(59, 130, 246, 0.1)');
  const cardBg = isSelected ? selectedBg : useColorModeValue('white', 'gray.800');
  const cardBorder = isSelected ? 'blue.400' : useColorModeValue('gray.200', 'gray.700');

  return (
    <Box
      as="article"
      p={4}
      borderWidth="1px"
      borderRadius="md"
      bg={cardBg}
      borderColor={cardBorder}
      _hover={{ shadow: 'md', transform: 'translateY(-2px)' }}
      transition="all 0.2s"
    >
      <VStack align="stretch" spacing={3}>
        <HStack justify="space-between" align="start" spacing={4}>
          <Checkbox
            colorScheme="blue"
            isChecked={isSelected}
            iconColor="white"
            borderColor={cardBorder}
            onChange={(event) => {
              event.stopPropagation();
              onToggleSelect(vulnerability.cve);
            }}
            onClick={(event) => event.stopPropagation()}
          />
          <VStack align="start" spacing={1} flex={1}>
            <ChakraLink
              as={RouterLink}
              to={detailPath}
              fontWeight="bold"
              fontSize="lg"
              color={useColorModeValue('blue.600', 'blue.300')}
            >
              {vulnerability.cve}
            </ChakraLink>
            <Text fontSize="sm" color={metaTextColor}>
              {vulnerability.packageName} @ {vulnerability.packageVersion}
            </Text>
          </VStack>
          <VStack align="end" spacing={2}>
            <Badge colorScheme={severityColor} fontSize="sm">
              {vulnerability.severity.toUpperCase()}
            </Badge>
            <Badge colorScheme="blue" fontSize="sm">
              CVSS: {vulnerability.cvss.toFixed(1)}
            </Badge>
          </VStack>
        </HStack>

        <Text fontSize="sm" color={descriptionColor} noOfLines={2}>
          {vulnerability.description}
        </Text>

        <HStack fontSize="xs" color={infoColor} spacing={4}>
          <Text>Published: {new Date(vulnerability.published).toLocaleDateString()}</Text>
          {vulnerability.kaiStatus && (
            <Badge size="sm" variant="outline">
              {vulnerability.kaiStatus}
            </Badge>
          )}
          {vulnerability.link && (
            <ChakraLink href={vulnerability.link} isExternal color="blue.500">
              View Details
            </ChakraLink>
          )}
        </HStack>
      </VStack>
    </Box>
  );
}

export default memo(VulnerabilityCard);

