import {
  Drawer,
  DrawerOverlay,
  DrawerContent,
  DrawerHeader,
  DrawerBody,
  DrawerCloseButton,
  DrawerFooter,
  Button,
  VStack,
  HStack,
  Text,
  Badge,
  Box,
  SimpleGrid,
  Divider,
  useColorModeValue,
  useBreakpointValue,
} from '@chakra-ui/react';
import { FlattenedVulnerability } from '../../types/vulnerability';
import VulnerabilityComparisonChart from './VulnerabilityComparisonChart';

interface VulnerabilityComparisonDrawerProps {
  isOpen: boolean;
  onClose: () => void;
  vulnerabilities: FlattenedVulnerability[];
  onRemove: (cveId: string) => void;
  onClear: () => void;
  maxSelection: number;
}

function ComparisonCard({ vulnerability, onRemove, highlight }: { vulnerability: FlattenedVulnerability; onRemove: (cveId: string) => void; highlight: boolean }) {
  const cardBg = useColorModeValue(highlight ? 'orange.50' : 'gray.50', highlight ? 'rgba(251, 191, 36, 0.2)' : 'gray.800');
  const cardBorder = useColorModeValue(highlight ? 'orange.300' : 'gray.200', highlight ? 'orange.400' : 'gray.700');

  return (
    <Box borderWidth="2px" borderRadius="md" p={4} bg={cardBg} borderColor={cardBorder}>
      <HStack justify="space-between" align="start" mb={3}>
        <VStack align="start" spacing={2} maxW="70%">
          <Text fontWeight="bold" fontSize="lg" color={useColorModeValue('blue.600', 'blue.200')} noOfLines={1}>
            {vulnerability.cve}
          </Text>
          <HStack spacing={2}>
            <Badge colorScheme="red" fontSize="sm">
              {vulnerability.severity.toUpperCase()}
            </Badge>
            <Badge colorScheme="blue" fontSize="sm">
              CVSS: {vulnerability.cvss.toFixed(1)}
            </Badge>
            {vulnerability.kaiStatus && (
              <Badge colorScheme="purple" fontSize="sm">
                {vulnerability.kaiStatus}
              </Badge>
            )}
          </HStack>
        </VStack>
        <Button size="sm" variant="ghost" colorScheme="red" onClick={() => onRemove(vulnerability.cve)}>
          Remove
        </Button>
      </HStack>
      <SimpleGrid columns={{ base: 1, md: 2 }} spacing={3} fontSize="sm" color="gray.700">
        <Box>
          <Text fontWeight="medium" color={useColorModeValue('gray.700', 'gray.200')}>Package</Text>
          <Text color={useColorModeValue('gray.600', 'gray.300')}>{vulnerability.packageName} @ {vulnerability.packageVersion}</Text>
        </Box>
        <Box>
          <Text fontWeight="medium" color={useColorModeValue('gray.700', 'gray.200')}>Published</Text>
          <Text color={useColorModeValue('gray.600', 'gray.300')}>{new Date(vulnerability.published).toLocaleDateString()}</Text>
        </Box>
        <Box>
          <Text fontWeight="medium" color={useColorModeValue('gray.700', 'gray.200')}>Status</Text>
          <Text color={useColorModeValue('gray.600', 'gray.300')}>{vulnerability.status || 'N/A'}</Text>
        </Box>
        <Box>
          <Text fontWeight="medium" color={useColorModeValue('gray.700', 'gray.200')}>Owner</Text>
          <Text color={useColorModeValue('gray.600', 'gray.300')}>{vulnerability.owner || 'N/A'}</Text>
        </Box>
      </SimpleGrid>
      <Divider my={3} />
      <Box fontSize="sm" color="gray.600">
        <Text fontWeight="medium" mb={1}>Risk Factors</Text>
        {Object.keys(vulnerability.riskFactors || {}).length > 0 ? (
          <HStack spacing={2} wrap="wrap">
            {Object.keys(vulnerability.riskFactors).map((factor) => (
              <Badge key={factor} colorScheme="blue" variant="subtle">
                {factor}
              </Badge>
            ))}
          </HStack>
        ) : (
          <Text color="gray.500">No risk factors</Text>
        )}
      </Box>
    </Box>
  );
}

export default function VulnerabilityComparisonDrawer({
  isOpen,
  onClose,
  vulnerabilities,
  onRemove,
  onClear,
  maxSelection,
}: VulnerabilityComparisonDrawerProps) {
  const canClear = vulnerabilities.length > 0;
  const highestCvss = vulnerabilities.reduce((max, vuln) => Math.max(max, vuln.cvss), 0);
  const drawerSize = useBreakpointValue({ base: 'full', md: 'xl' });

  return (
    <Drawer isOpen={isOpen} placement="right" size={drawerSize} onClose={onClose}>
      <DrawerOverlay />
      <DrawerContent>
        <DrawerCloseButton />
        <DrawerHeader borderBottomWidth="1px">
          Compare Vulnerabilities ({vulnerabilities.length}/{maxSelection})
        </DrawerHeader>
        <DrawerBody>
          {vulnerabilities.length === 0 ? (
            <VStack py={10} spacing={3} color="gray.500">
              <Text>No vulnerabilities selected.</Text>
              <Text fontSize="sm">Choose two or more CVEs from the list to compare them side-by-side.</Text>
            </VStack>
          ) : (
            <VStack align="stretch" spacing={4}>
              <VulnerabilityComparisonChart vulnerabilities={vulnerabilities} />
              {vulnerabilities.map((vuln) => (
                <ComparisonCard
                  key={vuln.id}
                  vulnerability={vuln}
                  onRemove={onRemove}
                  highlight={vuln.cvss === highestCvss}
                />
              ))}
            </VStack>
          )}
        </DrawerBody>
        <DrawerFooter borderTopWidth="1px">
          <HStack spacing={3} w="100%">
            <Button variant="ghost" onClick={onClear} isDisabled={!canClear}>
              Clear All
            </Button>
            <Button onClick={onClose} colorScheme="blue" w="full" isDisabled={!canClear}>
              Close
            </Button>
          </HStack>
        </DrawerFooter>
      </DrawerContent>
    </Drawer>
  );
}
