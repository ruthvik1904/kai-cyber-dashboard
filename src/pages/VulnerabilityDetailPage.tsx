import { Link as RouterLink, useParams } from 'react-router-dom';
import { Box, VStack, Text, Spinner, Center, Divider, Button } from '@chakra-ui/react';
import VulnerabilityDetailHeader from '../components/vulnerabilities/VulnerabilityDetailHeader';
import VulnerabilityMetadataGrid from '../components/vulnerabilities/VulnerabilityMetadataGrid';
import RiskFactorsList from '../components/vulnerabilities/RiskFactorsList';
import { useVulnerabilityById } from '../hooks/useVulnerabilityData';

export default function VulnerabilityDetailPage() {
  const { cveId } = useParams<{ cveId: string }>();
  const { vulnerability, isLoading, isError, error, isNotFound } = useVulnerabilityById(cveId);

  if (isLoading) {
    return (
      <Center py={20}>
        <Spinner size="xl" />
      </Center>
    );
  }

  if (isError) {
    return (
      <Center py={20}>
        <VStack spacing={4}>
          <Text color="red.500">Failed to load vulnerability details.</Text>
          {error && (
            <Text color="gray.500" fontSize="sm">
              {error.message}
            </Text>
          )}
          <Button as={RouterLink} to="/vulnerabilities" colorScheme="blue">
            Back to Vulnerabilities
          </Button>
        </VStack>
      </Center>
    );
  }

  if (isNotFound || !vulnerability) {
    return (
      <Center py={20}>
        <VStack spacing={4}>
          <Text fontSize="lg" fontWeight="bold">
            Vulnerability not found
          </Text>
          <Text color="gray.500">
            The requested CVE ({cveId}) is not available in the current dataset.
          </Text>
          <Button as={RouterLink} to="/vulnerabilities" colorScheme="blue">
            Back to Vulnerabilities
          </Button>
        </VStack>
      </Center>
    );
  }

  return (
    <VStack align="stretch" spacing={6}>
      <VulnerabilityDetailHeader vulnerability={vulnerability} />

      <Box>
        <Text fontWeight="bold" mb={2}>
          Description
        </Text>
        <Text color="gray.700" whiteSpace="pre-line">
          {vulnerability.description}
        </Text>
      </Box>

      <VulnerabilityMetadataGrid vulnerability={vulnerability} />

      <Divider />

      <RiskFactorsList vulnerability={vulnerability} />

      <Divider />

      <Box>
        <Text fontWeight="bold" mb={2}>
          Additional Details
        </Text>
        <VStack align="start" spacing={2} color="gray.600">
          <Text>
            Vector String: {vulnerability.vecStr || 'N/A'}
          </Text>
          <Text>
            Exploit Availability: {vulnerability.exploit || 'Unknown'}
          </Text>
          <Text>
            Advisory Type: {vulnerability.advisoryType || 'N/A'}
          </Text>
        </VStack>
      </Box>
    </VStack>
  );
}
