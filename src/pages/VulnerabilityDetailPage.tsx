import { Link as RouterLink, useParams } from 'react-router-dom';
import { Box, VStack, Text, Spinner, Center, Divider, Button, useColorModeValue } from '@chakra-ui/react';
import VulnerabilityDetailHeader from '../components/vulnerabilities/VulnerabilityDetailHeader';
import VulnerabilityMetadataGrid from '../components/vulnerabilities/VulnerabilityMetadataGrid';
import RiskFactorsList from '../components/vulnerabilities/RiskFactorsList';
import { useVulnerabilityById } from '../hooks/useVulnerabilityData';

export default function VulnerabilityDetailPage() {
  const { cveId } = useParams<{ cveId: string }>();
  const { vulnerability, isLoading, isError, error, isNotFound } = useVulnerabilityById(cveId);
  const mutedText = useColorModeValue('gray.600', 'gray.300');
  const subtleText = useColorModeValue('gray.500', 'gray.400');
  const headingColor = useColorModeValue('gray.700', 'gray.200');
  const sectionBg = useColorModeValue('white', 'gray.800');
  const sectionBorder = useColorModeValue('gray.200', 'gray.700');

  if (isLoading) {
    return (
      <Center py={20}>
        <Spinner size="xl" />
      </Center>
    );
  }

  if (isError) {
    return (
      <Center py={20}>
        <VStack spacing={4}>
          <Text color="red.500">Failed to load vulnerability details.</Text>
          {error && (
            <Text color={subtleText} fontSize="sm">
              {error.message}
            </Text>
          )}
          <Button as={RouterLink} to="/vulnerabilities" colorScheme="blue">
            Back to Vulnerabilities
          </Button>
        </VStack>
      </Center>
    );
  }

  if (isNotFound || !vulnerability) {
    return (
      <Center py={20}>
        <VStack spacing={4}>
          <Text fontSize="lg" fontWeight="bold">
            Vulnerability not found
          </Text>
          <Text color={subtleText}>
            The requested CVE ({cveId}) is not available in the current dataset.
          </Text>
          <Button as={RouterLink} to="/vulnerabilities" colorScheme="blue">
            Back to Vulnerabilities
          </Button>
        </VStack>
      </Center>
    );
  }

  return (
    <VStack align="stretch" spacing={6}>
      <VulnerabilityDetailHeader vulnerability={vulnerability} />

      <Box bg={sectionBg} borderWidth="1px" borderColor={sectionBorder} p={{ base: 4, md: 6 }} borderRadius="lg" shadow="sm">
        <Text fontWeight="bold" mb={2} color={headingColor}>
          Description
        </Text>
        <Text color={mutedText} whiteSpace="pre-line">
          {vulnerability.description}
        </Text>
      </Box>

      <VulnerabilityMetadataGrid vulnerability={vulnerability} />

      <Divider />

      <Box bg={sectionBg} borderWidth="1px" borderColor={sectionBorder} p={{ base: 4, md: 6 }} borderRadius="lg" shadow="sm">
        <RiskFactorsList vulnerability={vulnerability} />
      </Box>

      <Divider />

      <Box bg={sectionBg} borderWidth="1px" borderColor={sectionBorder} p={{ base: 4, md: 6 }} borderRadius="lg" shadow="sm">
        <Text fontWeight="bold" mb={2} color={headingColor}>
          Additional Details
        </Text>
        <VStack align="start" spacing={2} color={mutedText}>
          <Text>
            Vector String: {vulnerability.vecStr || 'N/A'}
          </Text>
          <Text>
            Exploit Availability: {vulnerability.exploit || 'Unknown'}
          </Text>
          <Text>
            Advisory Type: {vulnerability.advisoryType || 'N/A'}
          </Text>
        </VStack>
      </Box>
    </VStack>
  );
}
