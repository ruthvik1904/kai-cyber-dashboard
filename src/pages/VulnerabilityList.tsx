/**
 * Vulnerability listing page
 * Shows filtered list of vulnerabilities with Analysis buttons
 */

import { Box, Heading, Text, VStack, SimpleGrid } from '@chakra-ui/react';
import { useVulnerabilityFilters } from '../hooks/useVulnerabilityFilters';
import { useSortedVulnerabilities } from '../hooks/useSortedVulnerabilities';
import AnalysisButtons from '../components/analysis/AnalysisButtons';
import FilterImpactVisualization from '../components/analysis/FilterImpactVisualization';
import SearchBar from '../components/filters/SearchBar';
import FilterPanel from '../components/filters/FilterPanel';
import FilterChips from '../components/filters/FilterChips';
import VulnerabilityList from '../components/vulnerabilities/VulnerabilityList';
import VulnerabilityListHeader from '../components/vulnerabilities/VulnerabilityListHeader';

function VulnerabilityListPage() {
  const {
    filteredData,
    filterStats,
    updateFilter,
    clearFilters,
    isLoading,
    filters,
  } = useVulnerabilityFilters();
  console.log('filteredData', filteredData.length);
  const { sortedData, sortField, sortOrder, toggleSort } =
    useSortedVulnerabilities(filteredData);

  const handleSearch = (query: string) => {
    updateFilter('searchQuery', query || undefined);
  };

  const handleFilterChange = (newFilters: typeof filters) => {
    // Update each filter individually
    Object.entries(newFilters).forEach(([key, value]) => {
      updateFilter(key as keyof typeof filters, value);
    });
  };

  const handleRemoveFilter = (key: keyof typeof filters) => {
    updateFilter(key, undefined);
  };

  return (
    <VStack align="stretch" spacing={6}>
      <Box>
        <Heading size="xl" mb={2}>
          Vulnerability List
        </Heading>
        <Text color="gray.600">
          Browse and filter security vulnerabilities
        </Text>
      </Box>

      {/* Analysis Buttons */}
      <AnalysisButtons />

      {/* Filter Impact Visualization */}
      <FilterImpactVisualization />

      {/* Search and Filters */}
      <SimpleGrid columns={{ base: 1, lg: 3 }} spacing={6} alignItems="start">
        <Box gridColumn={{ base: '1', lg: 'span 2' }}>
          <SearchBar onSearch={handleSearch} />
        </Box>
        <Box alignSelf="start">
          <FilterPanel
            filters={filters}
            onFilterChange={handleFilterChange}
            onClear={clearFilters}
          />
        </Box>
      </SimpleGrid>

      {/* Filter Chips */}
      <FilterChips filters={filters} onRemoveFilter={handleRemoveFilter} />

      {/* Vulnerability List */}
      <Box bg="white" p={6} borderRadius="lg" shadow="md">
        <Heading size="md" mb={4}>
          Vulnerabilities ({sortedData.length.toLocaleString()})
        </Heading>
        <VulnerabilityListHeader
          sortField={sortField}
          sortOrder={sortOrder}
          onSort={toggleSort}
        />
        {isLoading ? (
          <Text>Loading vulnerabilities...</Text>
        ) : sortedData.length === 0 ? (
          <Text color="gray.500">No vulnerabilities found.</Text>
        ) : (
          <VulnerabilityList
            vulnerabilities={sortedData}
            height={600}
          />
        )}
      </Box>
    </VStack>
  );
}

export default VulnerabilityListPage;

