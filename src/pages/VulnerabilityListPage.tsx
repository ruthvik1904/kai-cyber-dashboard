/**
 * Vulnerability listing page
 * Shows filtered list of vulnerabilities with Analysis buttons
 */

import { Box, Heading, Text, VStack, SimpleGrid, useDisclosure, useToast, Button, Menu, MenuButton, MenuList, MenuItem, HStack, useColorModeValue, Drawer, DrawerOverlay, DrawerContent, DrawerHeader, DrawerBody, DrawerCloseButton, useBreakpointValue } from '@chakra-ui/react';
import { useVulnerabilityFilters } from '../hooks/useVulnerabilityFilters';
import { useSortedVulnerabilities } from '../hooks/useSortedVulnerabilities';
import AnalysisButtons from '../components/analysis/AnalysisButtons';
import FilterImpactVisualization from '../components/analysis/FilterImpactVisualization';
import SearchBar from '../components/filters/SearchBar';
import FilterPanel from '../components/filters/FilterPanel';
import FilterChips from '../components/filters/FilterChips';
import VulnerabilityList from '../components/vulnerabilities/VulnerabilityList';
import VulnerabilityListHeader from '../components/vulnerabilities/VulnerabilityListHeader';
import VulnerabilityComparisonDrawer from '../components/vulnerabilities/VulnerabilityComparisonDrawer';
import { useCallback, useEffect } from 'react';
import { exportVulnerabilitiesAsCSV, exportVulnerabilitiesAsJSON } from '../utils/exportHelpers';
import CriticalHighlights from '../components/vulnerabilities/CriticalHighlights';
import { useUserPreferences } from '../hooks/useUserPreferences';

function VulnerabilityListPage() {
  const {
    filteredData,
    updateFilter,
    clearFilters,
    applyAnalysis,
    applyAIAnalysis,
    isLoading,
    filters,
    filterStats,
    selectedCveIds,
    toggleSelection,
    selectAll,
    clearSelection,
    isSelected,
    maxSelection,
    selectedVulnerabilities,
    removeSelection,
    setFilters,
  } = useVulnerabilityFilters();
  const { preferences } = useUserPreferences();
  const {
    sortedData,
    sortField,
    sortOrder,
    toggleSort,
    setSortField,
    setSortOrder,
  } = useSortedVulnerabilities(
    filteredData,
    preferences.defaultSortField,
    preferences.defaultSortOrder
  );
  const { isOpen, onOpen, onClose } = useDisclosure();
  const toast = useToast();
  const panelBg = useColorModeValue('white', 'gray.800');
  const panelBorder = useColorModeValue('gray.200', 'gray.700');
  const mutedText = useColorModeValue('gray.600', 'gray.300');
  const subtleText = useColorModeValue('gray.500', 'gray.400');
  const filterDrawer = useDisclosure();
  const isMobile = useBreakpointValue({ base: true, md: false }) ?? false;

  const handleSearch = useCallback((query: string) => {
    updateFilter('searchQuery', query || undefined);
  }, [updateFilter]);

  const handleFilterChange = useCallback((newFilters: typeof filters) => {
    // Update each filter individually
    Object.entries(newFilters).forEach(([key, value]) => {
      updateFilter(key as keyof typeof filters, value);
    });
  }, [updateFilter]);

  const handleRemoveFilter = useCallback((key: keyof typeof filters) => {
    updateFilter(key, undefined);
  }, [updateFilter]);

  const handleToggleSelection = useCallback((cveId: string) => {
    if (!isSelected(cveId) && selectedCveIds.length >= maxSelection) {
      toast({
        title: `You can compare up to ${maxSelection} vulnerabilities at a time`,
        status: 'info',
        duration: 3000,
        isClosable: true,
      });
      return;
    }
    toggleSelection(cveId);
  }, [isSelected, selectedCveIds.length, maxSelection, toggleSelection, toast]);

  const exportDataset = useCallback(
    (rows: typeof sortedData, format: 'csv' | 'json', scope: 'all' | 'selected') => {
      if (rows.length === 0) {
        toast({
          title: `No ${scope} data to export`,
          status: 'info',
          duration: 3000,
          isClosable: true,
        });
        return;
      }

      if (format === 'csv') {
        exportVulnerabilitiesAsCSV(rows);
      } else {
        exportVulnerabilitiesAsJSON(rows);
      }

      toast({
        title: `${format.toUpperCase()} export started`,
        status: 'success',
        duration: 3000,
        isClosable: true,
      });
    },
    [toast]
  );

  const handleExportAllCSV = useCallback(() => {
    exportDataset(sortedData, 'csv', 'all');
  }, [exportDataset, sortedData]);

  const handleExportAllJSON = useCallback(() => {
    exportDataset(sortedData, 'json', 'all');
  }, [exportDataset, sortedData]);

  const handleExportSelectedCSV = useCallback(() => {
    exportDataset(selectedVulnerabilities, 'csv', 'selected');
  }, [exportDataset, selectedVulnerabilities]);

  const handleExportSelectedJSON = useCallback(() => {
    exportDataset(selectedVulnerabilities, 'json', 'selected');
  }, [exportDataset, selectedVulnerabilities]);

  useEffect(() => {
    setFilters(preferences.defaultFilters || {});
  }, [preferences.defaultFilters, setFilters]);

  useEffect(() => {
    setSortField(preferences.defaultSortField);
    setSortOrder(preferences.defaultSortOrder);
  }, [preferences.defaultSortField, preferences.defaultSortOrder, setSortField, setSortOrder]);

  return (
    <VStack align="stretch" spacing={6}>
      <Box>
        <Heading size="xl" mb={2}>
          Vulnerability List
        </Heading>
        <Text color={mutedText}>
          Browse and filter security vulnerabilities
        </Text>
      </Box>

      {/* Analysis Buttons */}
      <AnalysisButtons
        applyAnalysis={applyAnalysis}
        applyAIAnalysis={applyAIAnalysis}
        clearFilters={clearFilters}
        filters={filters}
        isLoading={isLoading}
      />

      {/* Critical highlights */}
      <CriticalHighlights vulnerabilities={sortedData} limit={isMobile ? 3 : 5} />

      <HStack justify="space-between" align="center" spacing={3}>
        <Box flex="1">
          <SearchBar onSearch={handleSearch} />
        </Box>
        {isMobile && (
          <Button variant="outline" colorScheme="blue" onClick={filterDrawer.onOpen}>
            Filters
          </Button>
        )}
      </HStack>

      {/* Filter Chips */}
      <FilterChips filters={filters} onRemoveFilter={handleRemoveFilter} />

      <SimpleGrid columns={{ base: 1, lg: 3 }} spacing={{ base: 4, md: 6 }} alignItems="start">
        <VStack align="stretch" spacing={6} gridColumn={{ base: '1', lg: 'span 2' }}>
          <Box bg={panelBg} borderWidth="1px" borderColor={panelBorder} p={{ base: 4, md: 6 }} borderRadius="lg" shadow="md">
            <HStack justify="space-between" align="center" mb={4}>
              <Heading size="md">
                Vulnerabilities ({sortedData.length.toLocaleString()})
              </Heading>
              <Menu>
                <MenuButton as={Button} colorScheme="blue" size="sm">
                  Export
                </MenuButton>
                <MenuList>
                  <MenuItem onClick={handleExportAllCSV} isDisabled={sortedData.length === 0}>
                    Export All (CSV)
                  </MenuItem>
                  <MenuItem onClick={handleExportAllJSON} isDisabled={sortedData.length === 0}>
                    Export All (JSON)
                  </MenuItem>
                  <MenuItem onClick={handleExportSelectedCSV} isDisabled={selectedVulnerabilities.length === 0}>
                    Export Selected (CSV)
                  </MenuItem>
                  <MenuItem onClick={handleExportSelectedJSON} isDisabled={selectedVulnerabilities.length === 0}>
                    Export Selected (JSON)
                  </MenuItem>
                </MenuList>
              </Menu>
            </HStack>
            <VStack align="stretch" spacing={4}>
              <HStack justify="space-between" align="center">
                <VulnerabilityListHeader
                  sortField={sortField}
                  sortOrder={sortOrder}
                  onSort={toggleSort}
                  selectedCount={selectedCveIds.length}
                  onClearSelection={clearSelection}
                  onSelectAllCurrent={() => selectAll(sortedData)}
                  maxSelectable={maxSelection}
                  onOpenComparison={onOpen}
                />
              </HStack>
            </VStack>
            {isLoading ? (
              <Text color={mutedText}>Loading vulnerabilities...</Text>
            ) : sortedData.length === 0 ? (
              <Text color={subtleText}>No vulnerabilities found.</Text>
            ) : (
              <VulnerabilityList
                vulnerabilities={sortedData}
                height={isMobile ? 420 : 600}
                isSelected={isSelected}
                onToggleSelect={handleToggleSelection}
              />
            )}
          </Box>
        </VStack>
        {!isMobile && (
          <VStack align="stretch" spacing={6}>
            <FilterPanel
              filters={filters}
              onFilterChange={handleFilterChange}
              onClear={clearFilters}
            />
            <FilterImpactVisualization filters={filters} filterStats={filterStats} />
          </VStack>
        )}
      </SimpleGrid>

      <VulnerabilityComparisonDrawer
        isOpen={isOpen}
        onClose={onClose}
        vulnerabilities={selectedVulnerabilities}
        onRemove={removeSelection}
        onClear={clearSelection}
        maxSelection={maxSelection}
      />

      <Drawer isOpen={filterDrawer.isOpen} placement="right" onClose={filterDrawer.onClose} size="full">
        <DrawerOverlay />
        <DrawerContent>
          <DrawerCloseButton />
          <DrawerHeader>Filters</DrawerHeader>
          <DrawerBody>
            <VStack align="stretch" spacing={6}>
              <FilterPanel
                filters={filters}
                onFilterChange={handleFilterChange}
                onClear={() => {
                  clearFilters();
                  filterDrawer.onClose();
                }}
              />
              <FilterImpactVisualization filters={filters} filterStats={filterStats} />
            </VStack>
          </DrawerBody>
        </DrawerContent>
      </Drawer>
    </VStack>
  );
}

export default VulnerabilityListPage;

