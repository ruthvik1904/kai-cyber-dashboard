/**
 * Vulnerability listing page
 * Shows filtered list of vulnerabilities with Analysis buttons
 */

import { Box, Heading, Text, VStack, SimpleGrid } from '@chakra-ui/react';
import { useVulnerabilityFilters } from '../hooks/useVulnerabilityFilters';
import { useSortedVulnerabilities } from '../hooks/useSortedVulnerabilities';
import AnalysisButtons from '../components/analysis/AnalysisButtons';
import FilterImpactVisualization from '../components/analysis/FilterImpactVisualization';
import SearchBar from '../components/filters/SearchBar';
import FilterPanel from '../components/filters/FilterPanel';
import FilterChips from '../components/filters/FilterChips';
import VulnerabilityList from '../components/vulnerabilities/VulnerabilityList';
import VulnerabilityListHeader from '../components/vulnerabilities/VulnerabilityListHeader';
import { useCallback } from 'react';

function VulnerabilityListPage() {
  const {
    filteredData,
    updateFilter,
    clearFilters,
    applyAnalysis,
    applyAIAnalysis,
    isLoading,
    filters,
    filterStats,
  } = useVulnerabilityFilters();
  const { sortedData, sortField, sortOrder, toggleSort } =
    useSortedVulnerabilities(filteredData);

  const handleSearch = useCallback((query: string) => {
    updateFilter('searchQuery', query || undefined);
  }, [updateFilter]);

  const handleFilterChange = useCallback((newFilters: typeof filters) => {
    // Update each filter individually
    Object.entries(newFilters).forEach(([key, value]) => {
      updateFilter(key as keyof typeof filters, value);
    });
  }, [updateFilter]);

  const handleRemoveFilter = useCallback((key: keyof typeof filters) => {
    updateFilter(key, undefined);
  }, [updateFilter]);

  return (
    <VStack align="stretch" spacing={6}>
      <Box>
        <Heading size="xl" mb={2}>
          Vulnerability List
        </Heading>
        <Text color="gray.600">
          Browse and filter security vulnerabilities
        </Text>
      </Box>

      {/* Analysis Buttons */}
      <AnalysisButtons
        applyAnalysis={applyAnalysis}
        applyAIAnalysis={applyAIAnalysis}
        clearFilters={clearFilters}
        filters={filters}
        isLoading={isLoading}
      />

      <SimpleGrid columns={{ base: 1, lg: 3 }} spacing={6} alignItems="start">
        <VStack align="stretch" spacing={6} gridColumn={{ base: '1', lg: 'span 2' }}>
          <SearchBar onSearch={handleSearch} />
          <FilterChips filters={filters} onRemoveFilter={handleRemoveFilter} />
          <Box bg="white" p={6} borderRadius="lg" shadow="md">
            <Heading size="md" mb={4}>
              Vulnerabilities ({sortedData.length.toLocaleString()})
            </Heading>
            <VulnerabilityListHeader
              sortField={sortField}
              sortOrder={sortOrder}
              onSort={toggleSort}
            />
            {isLoading ? (
              <Text>Loading vulnerabilities...</Text>
            ) : sortedData.length === 0 ? (
              <Text color="gray.500">No vulnerabilities found.</Text>
            ) : (
              <VulnerabilityList
                vulnerabilities={sortedData}
                height={600}
              />
            )}
          </Box>
        </VStack>
        <VStack align="stretch" spacing={6}>
          <FilterPanel
            filters={filters}
            onFilterChange={handleFilterChange}
            onClear={clearFilters}
          />
          <FilterImpactVisualization filters={filters} filterStats={filterStats} />
        </VStack>
      </SimpleGrid>
    </VStack>
  );
}

export default VulnerabilityListPage;

