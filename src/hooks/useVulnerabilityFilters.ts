/**
 * Hook for filtering vulnerabilities and managing filter state
 * Combines filter state management with filtering logic
 */

import { useState, useMemo, useCallback } from 'react';
import { useVulnerabilityData } from './useVulnerabilityData';
import { filterVulnerabilities } from '../utils/dataTransform';
import { FlattenedVulnerability } from '../types/vulnerability';

export interface FilterState {
  severity?: string[];
  kaiStatus?: string[];
  excludeKaiStatus?: string[];
  packageName?: string;
  searchQuery?: string;
}

export interface FilterStats {
  total: number;
  filtered: number;
  excluded: number;
}

export interface UseVulnerabilityFiltersResult {
  filteredData: FlattenedVulnerability[];
  allData: FlattenedVulnerability[];
  filters: FilterState;
  setFilters: (filters: FilterState) => void;
  updateFilter: <K extends keyof FilterState>(
    key: K,
    value: FilterState[K]
  ) => void;
  clearFilters: () => void;
  applyAnalysis: () => void;
  applyAIAnalysis: () => void;
  filterStats: FilterStats;
  isLoading: boolean;
}

/**
 * Combined hook for filtering vulnerabilities and managing filter state
 * Handles Analysis and AI Analysis button logic
 */
export function useVulnerabilityFilters(): UseVulnerabilityFiltersResult {
  const { vulnerabilities: allData, isLoading } = useVulnerabilityData();
  const [filters, setFilters] = useState<FilterState>({});

  // Memoize filtered data for performance
  const filteredData = useMemo(() => {
    if (!allData || allData.length === 0) {
      return [];
    }
    return filterVulnerabilities(allData, filters);
  }, [allData, filters]);

  // Update a specific filter
  const updateFilter = useCallback(
    <K extends keyof FilterState>(key: K, value: FilterState[K]) => {
      setFilters((prev) => ({
        ...prev,
        [key]: value,
      }));
    },
    []
  );

  // Clear all filters
  const clearFilters = useCallback(() => {
    setFilters({});
  }, []);

  // Apply Analysis filter - exclude "invalid - norisk"
  const applyAnalysis = useCallback(() => {
    setFilters((prev) => ({
      ...prev,
      excludeKaiStatus: ['invalid - norisk'],
    }));
  }, []);

  // Apply AI Analysis filter - exclude "ai-invalid-norisk"
  const applyAIAnalysis = useCallback(() => {
    setFilters((prev) => ({
      ...prev,
      excludeKaiStatus: ['ai-invalid-norisk'],
    }));
  }, []);

  // Calculate filter statistics
  const filterStats = useMemo((): FilterStats => {
    const total = allData.length;
    const filtered = filteredData.length;
    const excluded = total - filtered;
    return {
      total,
      filtered,
      excluded,
    };
  }, [allData.length, filteredData.length]);

  return {
    filteredData,
    allData,
    filters,
    setFilters,
    updateFilter,
    clearFilters,
    applyAnalysis,
    applyAIAnalysis,
    filterStats,
    isLoading,
  };
}

